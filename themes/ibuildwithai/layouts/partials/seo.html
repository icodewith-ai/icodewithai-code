{{/* SEO Partial for iBuildWith.ai */}}
{{/* This partial handles all SEO meta tags with centralized YAML configuration */}}

{{/* Load defaults */}}
{{ $defaults := .Site.Data.seo.defaults }}

{{/* Determine the appropriate SEO file to load based on page type */}}
{{ $seoData := dict }}
{{ $pageType := "" }}

{{/* Single pages - Dynamic lookup */}}
{{ if and (not .Section) .IsPage }}
  {{ $slugName := "" }}
  {{ if .IsHome }}
    {{ $slugName = "homepage" }}
  {{ else }}
    {{/* Use the content file name as default */}}
    {{ $slugName = .File.BaseFileName }}
    {{/* Allow override via frontmatter */}}
    {{ if .Params.seo_slug }}
      {{ $slugName = .Params.seo_slug }}
    {{ end }}
  {{ end }}
  
  {{ $pageType = $slugName }}
  {{ with index .Site.Data.seo "single-pages" $slugName }}
    {{ $seoData = . }}
  {{ end }}
{{/* Content sections - List pages vs Individual content */}}
{{ else if .Section }}
  {{ if and .IsPage (not .IsSection) }}
    {{/* Individual content item */}}
    {{ $contentSlug := "" }}
    {{ if eq .File.BaseFileName "index" }}
      {{/* For content in folders with index.md, use the folder name */}}
      {{ $contentSlug = .File.Dir | path.Base }}
    {{ else }}
      {{/* For content with direct filenames, use the base filename */}}
      {{ $contentSlug = .File.BaseFileName }}
    {{ end }}
    {{ $pageType = printf "%s-%s" .Section $contentSlug }}
    
    {{/* Try to load individual content SEO file from entries subfolder */}}
    {{ with index .Site.Data.seo "content-types" .Section }}
      {{ with .entries }}
        {{ $individualSEO := index . $contentSlug }}
        {{ if $individualSEO }}
          {{ $seoData = $individualSEO }}
        {{ end }}
      {{ end }}
      {{ if not $seoData }}
        {{/* Fallback to frontmatter + content-type defaults */}}
        {{ $frontmatterSEO := dict }}
        {{ if $.Params.title }}{{ $frontmatterSEO = merge $frontmatterSEO (dict "title" $.Title) }}{{ end }}
        {{ if $.Summary }}{{ $frontmatterSEO = merge $frontmatterSEO (dict "description" $.Summary) }}{{ end }}
        
        {{/* Merge with content-type defaults for unspecified fields */}}
        {{ with .listpage }}
          {{ $seoData = merge $frontmatterSEO . }}
        {{ else }}
          {{ $seoData = $frontmatterSEO }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ else }}
    {{/* List page */}}
    {{ $pageType = printf "%s-listpage" .Section }}
    {{ with index .Site.Data.seo "content-types" .Section }}
      {{ with .listpage }}
        {{ $seoData = . }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Helper function to resolve field values with inheritance */}}
{{ $resolveField := dict }}
{{ range $field := slice "title" "description" "author" "site_name" "social_image" "social_image_alt" "twitter_card_type" "twitter_site" "twitter_creator" "og_image_width" "og_image_height" "og_image_type" "canonical_base_url" "language" "locale" "robots" "noindex" "search_console_verification" }}
  {{ $value := "" }}
  
  {{ if $seoData }}
    {{ $value = index $seoData $field }}
  {{ end }}
  
  {{/* Handle inheritance syntax (defaults.fieldname) */}}
  {{ if hasPrefix $value "defaults." }}
    {{ $defaultField := strings.TrimPrefix $value "defaults." }}
    {{ $value = index $defaults $defaultField }}
  {{ end }}
  
  {{/* Fallback to defaults if no value found */}}
  {{ if not $value }}
    {{ $value = index $defaults $field }}
  {{ end }}
  
  {{ $resolveField = merge $resolveField (dict $field $value) }}
{{ end }}

{{/* Extract resolved values */}}
{{ $title := index $resolveField "title" }}
{{ $description := index $resolveField "description" }}
{{ $author := index $resolveField "author" }}
{{ $siteName := index $resolveField "site_name" }}
{{ $socialImage := index $resolveField "social_image" }}
{{ $socialImageAlt := index $resolveField "social_image_alt" }}
{{ $twitterCardType := index $resolveField "twitter_card_type" }}
{{ $twitterSite := index $resolveField "twitter_site" }}
{{ $twitterCreator := index $resolveField "twitter_creator" }}
{{ $ogImageWidth := index $resolveField "og_image_width" }}
{{ $ogImageHeight := index $resolveField "og_image_height" }}
{{ $ogImageType := index $resolveField "og_image_type" }}
{{ $canonicalBaseUrl := index $resolveField "canonical_base_url" }}
{{ $language := index $resolveField "language" }}
{{ $locale := index $resolveField "locale" }}
{{ $robots := index $resolveField "robots" }}
{{ $noindex := index $resolveField "noindex" }}
{{ $searchConsoleVerification := index $resolveField "search_console_verification" }}

{{/* SEO Validation Comments (visible in page source for debugging) */}}
{{ $titleLen := len $title }}
{{ $descLen := len $description }}
{{ if gt $titleLen 60 }}<!-- SEO WARNING: Title is {{ $titleLen }} characters (optimal: 50-60) -->{{ end }}
{{ if gt $descLen 160 }}<!-- SEO WARNING: Description is {{ $descLen }} characters (optimal: 150-160) -->{{ end }}
{{ if lt $descLen 120 }}<!-- SEO INFO: Description is {{ $descLen }} characters (could be longer for better engagement) -->{{ end }}

{{/* Basic SEO Meta Tags */}}
<title>{{ $title }}</title>
<meta name="description" content="{{ $description }}">
<meta name="author" content="{{ $author }}">

{{/* Advanced Robots meta tag control */}}
{{ if .Site.Params.noindex }}
{{/* Staging/dev environment - always noindex */}}
<meta name="robots" content="noindex, nofollow">
{{ else if eq $noindex "true" }}
{{/* Page-specific noindex */}}
<meta name="robots" content="noindex, follow">
{{ else if $robots }}
{{/* Custom robots directive */}}
<meta name="robots" content="{{ $robots }}">
{{ end }}

{{/* Search Console Verification */}}
{{ if $searchConsoleVerification }}
<meta name="google-site-verification" content="{{ $searchConsoleVerification }}">
{{ end }}

{{/* Canonical URL */}}
<link rel="canonical" href="{{ $canonicalBaseUrl }}{{ .RelPermalink }}">

{{/* Open Graph / Social Media */}}
<meta property="og:type" content="{{ if .IsHome }}website{{ else }}article{{ end }}">
<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $description }}">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:site_name" content="{{ $siteName }}">
<meta property="og:locale" content="{{ $locale }}">

{{/* Content-specific Open Graph tags */}}
{{ if eq .Section "blog" }}
{{ with .Date }}
<meta property="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}">
{{ end }}
{{ with .Lastmod }}
<meta property="article:modified_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}">
{{ end }}
<meta property="article:author" content="{{ $canonicalBaseUrl }}/about-marcelo/">
<meta property="article:section" content="AI Development">
{{ range .Params.tags }}
<meta property="article:tag" content="{{ . }}">
{{ end }}
{{ else if eq .Section "apps" }}
<meta property="og:type" content="website">
{{ else if eq .Section "events" }}
{{ with .Date }}
<meta property="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}">
{{ end }}
{{ else if eq .Section "podcast" }}
{{ with .Date }}
<meta property="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}">
{{ end }}
{{ else if eq .Section "videos" }}
{{ if and .IsPage (not .IsSection) }}
<meta property="og:type" content="video.other">
{{ with .Params.video_url }}
{{ $videoID := "" }}
{{ if (findRE "youtu\\.be/" .) }}
  {{ $videoID = index (last 1 (split . "/")) 0 }}
{{ else if (findRE "watch\\?v=" .) }}
  {{ $videoID = index (split (index (last 1 (split . "v=")) 0) "&") 0 }}
{{ else if (findRE "embed/" .) }}
  {{ $videoID = index (last 1 (split . "/")) 0 }}
{{ end }}
{{ if $videoID }}
<meta property="og:video" content="https://www.youtube.com/embed/{{ $videoID }}">
<meta property="og:video:secure_url" content="https://www.youtube.com/embed/{{ $videoID }}">
<meta property="og:video:type" content="text/html">
<meta property="og:video:width" content="1280">
<meta property="og:video:height" content="720">
{{ end }}
{{ end }}
{{ with .Params.date_time }}
<meta property="video:release_date" content="{{ . }}">
{{ end }}
{{ end }}
{{ end }}

{{/* Enhanced Social Media Image with Fallback Logic */}}
{{ $finalSocialImage := "" }}
{{ $finalSocialImageAlt := "" }}

{{/* Step 1: Try page-specific image */}}
{{ if $socialImage }}
  {{/* Check if it's a path (string starting with "images/") */}}
  {{ if hasPrefix $socialImage "images/" }}
    {{ $pageImage := resources.Get $socialImage }}
    {{ if $pageImage }}
      {{ $finalSocialImage = $pageImage.RelPermalink }}
      {{ $finalSocialImageAlt = $socialImageAlt }}
    {{ end }}
  {{ else }}
    {{/* Assume it's already a full URL */}}
    {{ $finalSocialImage = $socialImage }}
    {{ $finalSocialImageAlt = $socialImageAlt }}
  {{ end }}
{{ end }}

{{/* Step 2: Try content-type specific image if no page-specific image */}}
{{ if not $finalSocialImage }}
  {{ if .Section }}
    {{ $contentTypeImagePath := printf "images/seo/content-types/%s/listpage-social.png" .Section }}
    {{ $contentTypeImage := resources.Get $contentTypeImagePath }}
    {{ if $contentTypeImage }}
      {{ $finalSocialImage = $contentTypeImage.RelPermalink }}
      {{ $finalSocialImageAlt = printf "%s - %s" .Section $siteName }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Step 3: Fallback to default image */}}
{{ if not $finalSocialImage }}
  {{ with resources.Get "images/seo/default-social.png" }}
    {{ $finalSocialImage = .RelPermalink }}
    {{ $finalSocialImageAlt = printf "%s - %s" $siteName $description }}
  {{ end }}
{{ end }}

{{/* Generate social media image meta tags */}}
{{ if $finalSocialImage }}
<meta property="og:image" content="{{ $finalSocialImage | absURL }}">
<meta property="og:image:width" content="{{ $ogImageWidth }}">
<meta property="og:image:height" content="{{ $ogImageHeight }}">
<meta property="og:image:type" content="{{ $ogImageType }}">
{{ if $finalSocialImageAlt }}
<meta property="og:image:alt" content="{{ $finalSocialImageAlt }}">
{{ end }}
<meta name="twitter:image" content="{{ $finalSocialImage | absURL }}">
{{ if $finalSocialImageAlt }}
<meta name="twitter:image:alt" content="{{ $finalSocialImageAlt }}">
{{ end }}
{{ end }}

{{/* Enhanced Twitter Card */}}
<meta name="twitter:card" content="{{ $twitterCardType }}">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $description }}">
{{ if $twitterSite }}
<meta name="twitter:site" content="{{ $twitterSite }}">
{{ end }}
{{ if $twitterCreator }}
<meta name="twitter:creator" content="{{ $twitterCreator }}">
{{ end }}

{{/* Enhanced JSON-LD Structured Data */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  {{ if .IsHome }}
  "@type": "WebSite",
  "name": "{{ $siteName }}",
  "url": "{{ $canonicalBaseUrl }}",
  "description": "{{ $description }}",
  {{ if $finalSocialImage }}
  "image": "{{ $finalSocialImage | absURL }}",
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}",
    {{ if $finalSocialImage }}
    "logo": {
      "@type": "ImageObject",
      "url": "{{ $finalSocialImage | absURL }}",
      "width": {{ $ogImageWidth }},
      "height": {{ $ogImageHeight }}
    },
    {{ end }}
    "sameAs": [
      "https://www.linkedin.com/company/ibuildwithai/",
      "https://x.com/ibuildwith_ai",
      "https://www.youtube.com/@ibuildwith_ai",
      "https://github.com/ibuildwith-ai"
    ]
  }
  {{ else if eq .Section "blog" }}
  "@type": "BlogPosting",
  "headline": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  {{ if $finalSocialImage }}
  "image": {
    "@type": "ImageObject",
    "url": "{{ $finalSocialImage | absURL }}",
    "width": {{ $ogImageWidth }},
    "height": {{ $ogImageHeight }}
  },
  {{ end }}
  {{ with .Date }}
  "datePublished": "{{ .Format "2006-01-02T15:04:05Z07:00" }}",
  {{ end }}
  {{ with .Lastmod }}
  "dateModified": "{{ .Format "2006-01-02T15:04:05Z07:00" }}",
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}"
    {{ if $finalSocialImage }}
    ,"logo": {
      "@type": "ImageObject",
      "url": "{{ $finalSocialImage | absURL }}"
    }
    {{ end }}
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ .Permalink }}"
  }
  {{ else if eq .Section "apps" }}
  "@type": "SoftwareApplication",
  "name": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Web",
  {{ if $finalSocialImage }}
  "screenshot": {
    "@type": "ImageObject",
    "url": "{{ $finalSocialImage | absURL }}",
    "width": {{ $ogImageWidth }},
    "height": {{ $ogImageHeight }}
  },
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}"
  }
  {{ else if and (eq .Section "events") (and .IsPage (not .IsSection)) }}
  "@type": "Event",
  "name": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  {{ if $finalSocialImage }}
  "image": [
    "{{ $finalSocialImage | absURL }}"
  ],
  {{ end }}
  {{ with .Params.date_time }}
  "startDate": "{{ . }}",
  {{ end }}
  {{ if .Params.end_date_time }}
  "endDate": "{{ .Params.end_date_time }}",
  {{ end }}
  {{ with .Params.status }}
  "eventStatus": "https://schema.org/{{ if eq . "upcoming" }}EventScheduled{{ else if eq . "on-demand" }}EventMovedOnline{{ else if eq . "completed" }}EventScheduled{{ else }}EventScheduled{{ end }}",
  {{ end }}
  {{ with .Params.meeting_type }}
  "eventAttendanceMode": "https://schema.org/{{ if eq . "online" }}OnlineEventAttendanceMode{{ else if eq . "in-person" }}OfflineEventAttendanceMode{{ else if eq . "hybrid" }}MixedEventAttendanceMode{{ else }}OfflineEventAttendanceMode{{ end }}",
  {{ end }}
  {{ with .Params.location }}
  "location": {
    "@type": "Place",
    "name": "{{ . }}"{{ if $.Params.location_address }},
    "address": {
      "@type": "PostalAddress",
      "name": "{{ $.Params.location_address }}"
    }{{ end }}
  },
  {{ end }}
  {{ if .Params.presenter }}
  "performer": [
    {{ $presenters := split .Params.presenter "," }}
    {{ range $index, $presenterSlug := $presenters }}
    {{ $presenterSlug = trim $presenterSlug " " }}
    {{ $personData := index $.Site.Data.people $presenterSlug }}
    {{ if $personData }}
    {
      "@type": "Person",
      "name": "{{ $personData.fullName }}"{{ if $personData.learnMoreLink }},
      "url": "{{ $personData.learnMoreLink }}"{{ end }}
    }{{ if lt (add $index 1) (len $presenters) }},{{ end }}
    {{ end }}
    {{ end }}
  ],
  {{ end }}
  "organizer": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}"
  },
  {{ if or .Params.register_url (eq .Params.status "upcoming") }}
  "offers": {
    "@type": "Offer",
    "url": "{{ if .Params.register_url }}{{ .Params.register_url }}{{ else }}{{ .Permalink }}{{ end }}",
    "price": "0",
    "priceCurrency": "USD",
    "availability": "https://schema.org/{{ if eq .Params.status "completed" }}SoldOut{{ else }}InStock{{ end }}",
    "validFrom": "{{ now.Format "2006-01-02T15:04:05Z07:00" }}"
  },
  {{ end }}
  {{ with .Date }}
  "datePublished": "{{ .Format "2006-01-02T15:04:05Z07:00" }}",
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  }
  {{ else if eq .Section "podcast" }}
  "@type": "PodcastEpisode",
  "name": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  {{ with .Date }}
  "datePublished": "{{ .Format "2006-01-02T15:04:05Z07:00" }}",
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "partOf": {
    "@type": "PodcastSeries",
    "name": "Building with AI Podcast",
    "url": "{{ $canonicalBaseUrl }}/podcast/"
  }
  {{ else if and (eq .Section "videos") (and .IsPage (not .IsSection)) }}
  "@type": "VideoObject",
  "name": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  {{ if $finalSocialImage }}
  "thumbnailUrl": [
    "{{ $finalSocialImage | absURL }}"
  ],
  {{ end }}
  {{ with .Params.date_time }}
  "uploadDate": "{{ . }}",
  {{ end }}
  {{ with .Params.video_url }}
  {{ $videoID := "" }}
  {{ if (findRE "youtu\\.be/" .) }}
    {{ $videoID = index (last 1 (split . "/")) 0 }}
  {{ else if (findRE "watch\\?v=" .) }}
    {{ $videoID = index (split (index (last 1 (split . "v=")) 0) "&") 0 }}
  {{ else if (findRE "embed/" .) }}
    {{ $videoID = index (last 1 (split . "/")) 0 }}
  {{ end }}
  {{ if $videoID }}
  "embedUrl": "https://www.youtube.com/embed/{{ $videoID }}",
  "contentUrl": "https://www.youtube.com/watch?v={{ $videoID }}",
  {{ end }}
  {{ end }}
  {{ if .Params.presenter }}
  "creator": [
    {{ $presenters := split .Params.presenter "," }}
    {{ range $index, $presenterSlug := $presenters }}
    {{ $presenterSlug = trim $presenterSlug " " }}
    {{ $personData := index $.Site.Data.people $presenterSlug }}
    {{ if $personData }}
    {
      "@type": "Person",
      "name": "{{ $personData.fullName }}"{{ if $personData.learnMoreLink }},
      "url": "{{ $personData.learnMoreLink }}"{{ end }}
    }{{ if lt (add $index 1) (len $presenters) }},{{ end }}
    {{ end }}
    {{ end }}
  ],
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}"
    {{ if $finalSocialImage }}
    ,"logo": {
      "@type": "ImageObject",
      "url": "{{ $finalSocialImage | absURL }}"
    }
    {{ end }}
  }
  {{ else if and (eq .Section "videos") .IsSection }}
  "@type": "CollectionPage",
  "name": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  {{ if $finalSocialImage }}
  "image": "{{ $finalSocialImage | absURL }}",
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}"
    {{ if $finalSocialImage }}
    ,"logo": {
      "@type": "ImageObject",
      "url": "{{ $finalSocialImage | absURL }}"
    }
    {{ end }}
  }
  {{ else }}
  "@type": "WebPage",
  "name": "{{ $title }}",
  "description": "{{ $description }}",
  "url": "{{ .Permalink }}",
  {{ if $finalSocialImage }}
  "image": "{{ $finalSocialImage | absURL }}",
  {{ end }}
  "author": {
    "@type": "Person",
    "name": "{{ $author }}",
    "url": "{{ $canonicalBaseUrl }}/about-marcelo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $siteName }}",
    "url": "{{ $canonicalBaseUrl }}"
    {{ if $finalSocialImage }}
    ,"logo": {
      "@type": "ImageObject",
      "url": "{{ $finalSocialImage | absURL }}"
    }
    {{ end }}
  }
  {{ end }}
}
</script>